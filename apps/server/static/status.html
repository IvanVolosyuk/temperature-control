<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Control</title>
    <link rel="icon" type="image/png" sizes="64x64" href="/static/favicon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/favicon-512.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#111827">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Using local copies of above:
     <script src="/static/chart.js"></script>
    <script src="/static/hammer.min.js"></script>
    <script src="/static/chartjs-plugin-zoom"></script>
    <link rel="stylesheet" href="/static/css2">
     -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <h1 class="page-title">Temperature Control</h1>

    <div class="room-card">
        <h2 class="room-title">Bedroom</h2>

        <div class="section">
            <h3 class="section-title">Temperature Sensor</h3>
            <div id="bedroom-sensor-status-container" class="status-indicator">
                <svg
                  class="status-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z" />
                </svg>
                <span id="bedroom-sensor-text" class="status-text">Loading...</span>
            </div>
            <div id="bedroom-sensor-data" class="sensor-data-text hidden">
                <p>Current: <span id="bedroom-current-temp" class="font-medium">N/A</span>째C</p>
                <p>Target: <span id="bedroom-target-temp" class="font-medium">N/A</span>째C</p>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Heater Relay</h3>
            <div id="bedroom-relay-status-container" class="status-indicator status-indicator--relay">
                <svg
                  class="status-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 2v10" />
                  <path d="M18.4 6.6a9 9 0 1 1-12.77.04" />
                </svg>
                <span id="bedroom-relay-text" class="status-text">Loading...</span>
            </div>
            <div class="button-group">
                <button id="bedroom-relay-toggle" class="button button--responsive-width button--default hidden">
                    Loading...
                </button>
                <button id="bedroom-control-btn" class="button button--responsive-width button--default hidden">
                    Loading...
                </button>
            </div>
            <div id="bedroom-timer-status" class="timer-status hidden"></div>
        </div>

        <div class="divider">
            <h3 class="section-title section-title--history">
                <span>Temperature History</span>
                <div class="chart-zoom-buttons">
                    <button id="bedroom-zoom-in" class="button button--chart-zoom">1h</button>
                    <button id="bedroom-zoom-out" class="button button--chart-zoom">All</button>
                </div>
            </h3>
            <div class="chart-container">
                <canvas id="bedroom-temperature-chart" class="temperature-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="room-card">
        <h2 class="room-title">Kids Bedroom</h2>

        <div class="section">
            <h3 class="section-title">Temperature Sensor</h3>
            <div id="kids-bedroom-sensor-status-container" class="status-indicator">
                <img src="/static/thermometer.svg" alt="Thermometer Icon" class="status-icon">
                <span id="kids-bedroom-sensor-text" class="status-text">Loading...</span>
            </div>
            <div id="kids-bedroom-sensor-data" class="sensor-data-text hidden">
                <p>Current: <span id="kids-bedroom-current-temp" class="font-medium">N/A</span>째C</p>
                <p>Target: <span id="kids-bedroom-target-temp" class="font-medium">N/A</span>째C</p>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title">Heater Relay</h3>
            <div id="kids-bedroom-relay-status-container" class="status-indicator status-indicator--relay">
                <img src="/static/power.svg" alt="Power Icon" class="status-icon">
                <span id="kids-bedroom-relay-text" class="status-text">Loading...</span>
            </div>
            <div class="button-group">
                <button id="kids-bedroom-relay-toggle" class="button button--responsive-width button--default hidden">
                    Loading...
                </button>
                <button id="kids-bedroom-control-btn" class="button button--responsive-width button--default hidden">
                    Loading...
                </button>
            </div>
            <div id="kids-bedroom-timer-status" class="timer-status hidden"></div>
        </div>

        <div class="divider">
            <h3 class="section-title section-title--history">
                <span>Temperature History</span>
                <div class="chart-zoom-buttons">
                    <button id="kids-bedroom-zoom-in" class="button button--chart-zoom">1h</button>
                    <button id="kids-bedroom-zoom-out" class="button button--chart-zoom">All</button>
                </div>
            </h3>
            <div class="chart-container">
                <canvas id="kids-bedroom-temperature-chart" class="temperature-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        var makeSettings = function() {
            const isDarkMode =  window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.85)';
            const currentTempColor = isDarkMode ? 'rgba(100, 180, 225, 0.25)' : 'rgb(59, 130, 146, 0.25)';
            const currentTempBgColor = isDarkMode ? 'rgba(100, 180, 243, 0.4)' : 'rgba(59, 130, 246, 0.4)';
            const targetTempColor = isDarkMode ? 'rgba(200, 200, 150, 0.7)' : 'rgb(150, 150, 100, 0.4)';
            const targetTempBgColor = isDarkMode ? 'rgba(90, 100, 90, 1)' : 'rgba(50, 50, 50, 1)';
            const pointHeaterOnColor = isDarkMode ? 'rgba(255, 80, 80, 1)' : 'rgb(239, 68, 68)'; // Brighter Red
            const pointHeaterOffColor = isDarkMode ? 'rgba(80, 80, 255, 1)' : 'rgb(59, 130, 246)';
            const disabledOnColor = isDarkMode ? 'rgba(180, 140, 140, 0.6)' : 'rgba(130, 100, 100, 0.6)'
            const disabledOffColor = isDarkMode ? 'rgba(140, 140, 180, 0.6)' : 'rgba(100, 100, 130, 0.6)'

            return {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Current Temperature',
                            borderColor: currentTempColor,
                            backgroundColor: currentTempBgColor,
                            data: [],
                            pointRadius: 4,
                            pointBackgroundColor: function(context) {
                                const index = context.dataIndex;
                                const dataset = context.dataset;
                                const color = dataset.data[index]?.heater_on ? pointHeaterOnColor : pointHeaterOffColor;
                                const disabledColor = dataset.data[index]?.heater_on ? disabledOnColor : disabledOffColor;
                                return dataset.data[index]?.heater_disabled ? disabledColor : color;
                            }
                        },
                        {
                            label: 'Target Temperature',
                            borderColor: targetTempBgColor,
                            backgroundColor: targetTempBgColor,
                            data: [],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            ticks: {
                                callback: function(value) {
                                    const date = new Date(value);
                                    return date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
                                },
                                color: textColor,
                                maxTicksLimit: 8,
                                autoSkip: true
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                color: textColor,
                                font: { size: 14 }
                            },
                            min: Date.now() - 3600 * 1000, // Show last 1 hour
                            max: Date.now(),
                            grid: { color: gridColor }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (째C)',
                                color: textColor,
                                font: { size: 14 }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '째C';
                                },
                                stepSize: 0.1,
                                maxTicksLimit: 6,
                                color: textColor
                            },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { mode: 'x', pinch: { enabled: true }, wheel: { enabled: true }}
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: textColor, font: {size: 14} }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const timestamp = context[0].parsed.x;
                                    const date = new Date(timestamp);
                                    return date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}째C`;
                                }
                            }
                        }
                    }
                }
            };
        }

        const bedroomChart = new Chart(document.getElementById('bedroom-temperature-chart').getContext('2d'), makeSettings());
        const kidsBedroomChart = new Chart(document.getElementById('kids-bedroom-temperature-chart').getContext('2d'), makeSettings());

        // Function to update chart colors based on theme
        function updateChartColors() {
            const newSettings = makeSettings();
            bedroomChart.options = newSettings.options;
            bedroomChart.data.datasets.forEach((dataset, index) => {
                dataset.borderColor = newSettings.data.datasets[index].borderColor;
                dataset.backgroundColor = newSettings.data.datasets[index].backgroundColor;
            });
            bedroomChart.update();

            kidsBedroomChart.options = newSettings.options;
            kidsBedroomChart.data.datasets.forEach((dataset, index) => {
                dataset.borderColor = newSettings.data.datasets[index].borderColor;
                dataset.backgroundColor = newSettings.data.datasets[index].backgroundColor;
            });
            kidsBedroomChart.update();
        }

        // Listen for changes in the color scheme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateChartColors);

        function merge(orig, newArray) {
            var originalArray = [...orig];
            if (originalArray.length === 0) {
                return originalArray.concat(newArray);
            }

            if (newArray.length === 0) {
                return originalArray;
            }

            const lastElementOfOriginal = originalArray[originalArray.length - 1];
            let startIndex = 0;
            while (startIndex < newArray.length && newArray[startIndex].x <= lastElementOfOriginal.x) {
                startIndex++;
            }

            // Extract the subarray from newArray starting from startIndex
            const subArrayToAppend = newArray.slice(startIndex);

            // Append the subarray to the originalArray
            return originalArray.concat(subArrayToAppend);
        };

        function updateChart(chart, history) {
            const currentData = merge(
                chart.data.datasets[0].data,
                history.map(point => ({
                    x: point.timestamp * 1000,
                    y: point.temperature,
                    heater_on: point.heater_on,
                    heater_disabled: point.is_disabled
                })));
            const targetData = merge(
                chart.data.datasets[1].data,
                history.map(point => ({
                    x: point.timestamp * 1000,
                    y: point.target
                })));


            var prevLen = chart.data.datasets[0].data.length;
            var isUpdated = false;

            if (currentData.length > 0) {
                var firstTimestamp = currentData[0].x;
                var lastTimestamp = currentData[currentData.length - 1].x;
                var dataRange = lastTimestamp - firstTimestamp;

                if (prevLen != 0) {
                    var prevLastTimestamp = chart.data.datasets[0].data[prevLen - 1].x;
                    isUpdated = lastTimestamp != prevLastTimestamp;
                } else {
                    isUpdated = true;
                }
            }

            var keepScrolling = false;
            if (isUpdated)  {
                keepScrolling = prevLastTimestamp <= chart.options.scales.x.max;
            }
            if (isUpdated) {
                console.log('isUpdated: ' + isUpdated + " keepScrolling " + keepScrolling);
            }

            chart.data.datasets[0].data = currentData;
            chart.data.datasets[1].data = targetData;

            const now = Date.now();

            if (currentData.length > 0) {
                const firstTimestamp = currentData[0].x;
                const lastTimestamp = currentData[currentData.length - 1].x;
                const dataRange = lastTimestamp - firstTimestamp;

                // Keep one point on screen
                if (lastTimestamp < chart.options.scales.x.min) {
                    var move = lastTimestamp - chart.options.scales.x.min;
                    chart.options.scales.x.min += move;
                    chart.options.scales.x.max += move;
                }
                if (firstTimestamp > chart.options.scales.x.max) {
                    var move = firstTimestamp - chart.options.scales.x.max;
                    chart.options.scales.x.min += move;
                    chart.options.scales.x.max += move;
                }
                var offset = (chart.options.scales.x.max - chart.options.scales.x.min) * 0.03;
                if (lastTimestamp + offset > chart.options.scales.x.max && keepScrolling) {
                    console.log('move: ' + chart.options.scales.x.max + " lastTimestamp " + lastTimestamp + " offset" + offset);
                    var move = lastTimestamp + offset - chart.options.scales.x.max;
                    chart.options.scales.x.min += move;
                    chart.options.scales.x.max += move;
                }
            } else {
                chart.options.scales.x.min = Math.max(now - 3600 * 1000, firstTimestamp - 60000);
                chart.options.scales.x.max = now + 60000;
            }
            chart.update();
        }

        // Track last update timestamp for both rooms
        let lastUpdateTimestamp = {
            bedroom: null,
            kids_bedroom: null
        };

        function updateRoomUI(roomPrefix, data) {
            const heaterDisabledUntil = data.disabled_until * 1000;

            // Sensor Elements
            const sensorTextEl = document.getElementById(`${roomPrefix}-sensor-text`);
            const sensorDataEl = document.getElementById(`${roomPrefix}-sensor-data`);
            const currentTempEl = document.getElementById(`${roomPrefix}-current-temp`);
            const targetTempEl = document.getElementById(`${roomPrefix}-target-temp`);

            // Relay Elements
            const relayTextEl = document.getElementById(`${roomPrefix}-relay-text`);
            const relayToggleBtn = document.getElementById(`${roomPrefix}-relay-toggle`);
            const controlBtn = document.getElementById(`${roomPrefix}-control-btn`);
            const timerStatusEl = document.getElementById(`${roomPrefix}-timer-status`);

            // Update Sensor UI
            if (data.sensor.available) {
                sensorTextEl.textContent = 'Available';
                sensorTextEl.className = 'status-text status-text--available'; // New class
                sensorDataEl.classList.remove('hidden');
                currentTempEl.textContent = data.sensor.currentTemp !== null ? data.sensor.currentTemp.toFixed(1) : 'N/A';
                targetTempEl.textContent = data.sensor.targetTemp !== null ? data.sensor.targetTemp.toFixed(1) : 'N/A';
            } else {
                sensorTextEl.textContent = 'Unavailable';
                sensorTextEl.className = 'status-text status-text--unavailable'; // New class
                sensorDataEl.classList.add('hidden');
                currentTempEl.textContent = 'N/A';
                targetTempEl.textContent = 'N/A';
            }

            // Update Relay UI
            relayToggleBtn.classList.remove('hidden');
            controlBtn.classList.remove('hidden');

            // Reset button classes before applying new state
            relayToggleBtn.className = 'button button--responsive-width'; // Base classes
            controlBtn.className = 'button button--responsive-width'; // Base classes


            if (data.relay.available) {
                const isHeaterDisabled = heaterDisabledUntil && Date.now() < heaterDisabledUntil;

                if (isHeaterDisabled) {
                    relayTextEl.textContent = 'Current: DISABLED';
                    relayTextEl.className = 'status-text status-text--disabled'; // New class

                    relayToggleBtn.textContent = 'Heater Disabled';
                    relayToggleBtn.classList.add('button--disabled');
                    relayToggleBtn.disabled = true;

                    controlBtn.textContent = 'Restore Heating';
                    controlBtn.classList.add('button--control-restore');
                    controlBtn.requestDisable = false; // Keep your existing logic for this custom property
                    controlBtn.disabled = false;

                    const timeLeft = Math.max(0, Math.round((heaterDisabledUntil - Date.now()) / 1000));
                    const minutes = Math.floor(timeLeft / 60);
                    // const seconds = timeLeft % 60; // Original code used minutes
                    timerStatusEl.textContent = `Automatic restore in: ${minutes} minutes`; // Corrected "minites"
                    timerStatusEl.classList.remove('hidden');

                } else { // Not disabled, or timer expired
                    relayTextEl.textContent = `Current: ${data.relay.state.toUpperCase()}`;
                    relayTextEl.className = 'status-text status-text--available'; // Assuming 'available' style for ON/OFF state text

                    relayToggleBtn.textContent = data.relay.state === 'On' ? 'Turn Off' : 'Turn On';
                    if (data.relay.state === 'On') {
                        relayToggleBtn.classList.add('button--relay-on');
                    } else {
                        relayToggleBtn.classList.add('button--relay-off');
                    }
                    relayToggleBtn.disabled = false;

                    controlBtn.textContent = 'Disable Heater for 2 Hours';
                    controlBtn.classList.add('button--control-disable');
                    controlBtn.requestDisable = true; // Keep your existing logic
                    controlBtn.disabled = false;
                    timerStatusEl.classList.add('hidden');
                }
            } else { // Relay unavailable
                relayTextEl.textContent = 'Unavailable';
                relayTextEl.className = 'status-text status-text--unavailable'; // New class

                relayToggleBtn.textContent = 'Toggle (Unavailable)';
                relayToggleBtn.classList.add('button--unavailable'); // Or 'button--disabled'
                relayToggleBtn.disabled = true;

                controlBtn.textContent = 'Disable (Unavailable)';
                controlBtn.classList.add('button--unavailable'); // Or 'button--disabled'
                controlBtn.disabled = true;
                timerStatusEl.classList.add('hidden');
            }

            const chart = roomPrefix === 'bedroom' ? bedroomChart : kidsBedroomChart;
            if (data.temperature_history) {
                updateChart(chart, data.temperature_history);
            }
        }

        async function controlRelay(room, newState) { // newState is boolean: true for On, false for Off
            const apiRoomName = room === 'kids-bedroom' ? 'kids_bedroom' : room;
            try {
                const response = await fetch('/api/relay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room: apiRoomName, state: newState })
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to control relay:', result.error);
                }
            } catch (error) {
                console.error('Error controlling relay:', error);
            }
            updateUI(); // Fetch latest state after trying to control
        }

        function handleDisableHeater(roomPrefix) {
            const apiRoomName = roomPrefix === 'kids-bedroom' ? 'kids_bedroom' : roomPrefix;
            fetch('/api/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: apiRoomName, disable: true })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.error('Failed to disable heater:', result.error);
                }
                updateUI();
            })
            .catch(error => {
                console.error('Error disabling heater:', error);
            });
        }

        function handleRestoreHeater(roomPrefix) {
            const apiRoomName = roomPrefix === 'kids-bedroom' ? 'kids_bedroom' : roomPrefix;
            fetch('/api/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: apiRoomName, disable: false })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.error('Failed to restore heater:', result.error);
                }
                updateUI();
            })
            .catch(error => {
                console.error('Error restoring heater:', error);
            });
        }

        async function updateUI() {
            try {
                // Build URL with last_update parameter if we have timestamps
                let url = '/api/status';
                const params = new URLSearchParams();

                // Only add last_update if we have timestamps for both rooms
                if (lastUpdateTimestamp.bedroom || lastUpdateTimestamp.kids_bedroom) {
                    // Use the most recent timestamp to ensure we don't miss any data
                    const latestTimestamp = Math.max(lastUpdateTimestamp.bedroom, lastUpdateTimestamp.kids_bedroom);
                    params.append('last_update', latestTimestamp.toString());
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                // Update last update timestamps if we got new data
                if (data.bedroom.temperature_history.length > 0) {
                    const lastPoint = data.bedroom.temperature_history[data.bedroom.temperature_history.length - 1];
                    lastUpdateTimestamp.bedroom = lastPoint.timestamp;
                }
                if (data.kids_bedroom.temperature_history.length > 0) {
                    const lastPoint = data.kids_bedroom.temperature_history[data.kids_bedroom.temperature_history.length - 1];
                    lastUpdateTimestamp.kids_bedroom = lastPoint.timestamp;
                }

                bedroomHeaterDisabledUntil = data.bedroom.disabled_until;
                kidsBedroomHeaterDisabledUntil = data.bedroom.disabled_until;

                updateRoomUI('bedroom', {
                    sensor: {
                        available: data.bedroom.sensor_available,
                        currentTemp: data.bedroom.current_temp,
                        targetTemp: data.bedroom.target_temp
                    },
                    relay: {
                        available: data.bedroom.relay_available,
                        state: data.bedroom.relay_state ? 'On' : 'Off'
                    },
                    temperature_history: data.bedroom.temperature_history,
                    disabled_until: data.bedroom.disabled_until

                });

                updateRoomUI('kids-bedroom', {
                    sensor: {
                        available: data.kids_bedroom.sensor_available,
                        currentTemp: data.kids_bedroom.current_temp,
                        targetTemp: data.kids_bedroom.target_temp
                    },
                    relay: {
                        available: data.kids_bedroom.relay_available,
                        state: data.kids_bedroom.relay_state ? 'On' : 'Off'
                    },
                    temperature_history: data.kids_bedroom.temperature_history,
                    disabled_until: data.kids_bedroom.disabled_until
                });
            } catch (error) {
                console.error('Error fetching status:', error);
                // Optionally show a global error message on the UI
                updateChart(chart, data.temperature_history);
            }
        }

        // Add click handlers for toggle buttons
        document.getElementById('bedroom-relay-toggle').addEventListener('click', function() {
            if (this.disabled) return;
            const currentRelayStateText = document.getElementById('bedroom-relay-text').textContent;
            const isCurrentlyOn = currentRelayStateText.includes('ON');
            controlRelay('bedroom', !isCurrentlyOn);
        });

        document.getElementById('kids-bedroom-relay-toggle').addEventListener('click', function() {
             if (this.disabled) return;
            const currentRelayStateText = document.getElementById('kids-bedroom-relay-text').textContent;
            const isCurrentlyOn = currentRelayStateText.includes('ON');
            controlRelay('kids-bedroom', !isCurrentlyOn);
        });

        // Add click handlers for control buttons (Disable/Restore)
        document.getElementById('bedroom-control-btn').addEventListener('click', function() {
            if (this.disabled) return;
            const isHeaterDisabled = !this.requestDisable;
            if (isHeaterDisabled) {
                handleRestoreHeater('bedroom');
            } else {
                handleDisableHeater('bedroom');
            }
        });

        document.getElementById('kids-bedroom-control-btn').addEventListener('click', function() {
            if (this.disabled) return;
            const isHeaterDisabled = !this.requestDisable;

            if (isHeaterDisabled) {
                handleRestoreHeater('kids-bedroom');
            } else {
                handleDisableHeater('kids-bedroom');
            }
        });

        setInterval(() => {
            if (document.hasFocus()) {
                updateUI();
            }
        }, 1000);
        updateUI();

        function zoomOutChart(chart) {
            const now = Date.now();
            const len = chart.data.datasets[0].data.length
            const offset = (chart.data.datasets[0].data[len-1].x - chart.data.datasets[0].data[0].x + 1) * 0.03;
            chart.options.scales.x.min = chart.data.datasets[0].data[0].x - offset;
            chart.options.scales.x.max = now + offset;
            chart.update();
        }

        function zoomInChart(chart) {
            const now = Date.now();
            const offset = 3600 * 1000 * 0.03;
            chart.options.scales.x.min = now - 3600 * 1000 - offset; // Last hour
            chart.options.scales.x.max = now + offset;
            chart.update();
        }

        // Add click handlers for zoom buttons
        document.getElementById('bedroom-zoom-out').addEventListener('click', () => zoomOutChart(bedroomChart));
        document.getElementById('bedroom-zoom-in').addEventListener('click', () => zoomInChart(bedroomChart));
        document.getElementById('kids-bedroom-zoom-out').addEventListener('click', () => zoomOutChart(kidsBedroomChart));
        document.getElementById('kids-bedroom-zoom-in').addEventListener('click', () => zoomInChart(kidsBedroomChart));
    </script>

</body>
</html>
