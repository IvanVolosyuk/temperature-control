<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Control</title>
    <link rel="icon" type="image/png" sizes="64x64" href="/static/favicon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/favicon-512.png">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#111827"> <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .temperature-chart { /* Kept for consistency if referenced, but height is now on .chart-container */
            width: 100%;
            height: 100%; /* Fill the container */
            max-height: 300px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 1rem; /* Original margin-top for chart spacing */
        }
        /* Ensure icons in buttons don't shrink too much if you add them */
        button img, button svg {
            flex-shrink: 0;
        }
        /* Dark mode styles */
        @media (prefers-color-scheme: dark) {
        }
    </style>
</head>
<body class="bg-gray-900 p-6 text-gray-100">

    <h1 class="text-3xl font-bold mb-6 text-gray-200">Room Temperature Control</h1>

    <div class="bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-300">Bedroom</h2>

        <div class="mb-4">
            <h3 class="text-xl font-medium text-gray-400 mb-1">Temperature Sensor</h3>
            <div id="bedroom-sensor-status-container" class="flex items-center">
                <img src="https://unpkg.com/lucide-static@latest/icons/thermometer.svg" alt="Thermometer Icon" class="w-6 h-6 mr-2 text-yellow-400">
                <span id="bedroom-sensor-text" class="text-lg text-gray-500">Loading...</span>
            </div>
            <div id="bedroom-sensor-data" class="mt-2 text-gray-300 text-lg hidden">
                <p>Current: <span id="bedroom-current-temp" class="font-medium">N/A</span>째C</p>
                <p>Target: <span id="bedroom-target-temp" class="font-medium">N/A</span>째C</p>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-xl font-medium text-gray-400 mb-1">Heater Relay</h3>
            <div id="bedroom-relay-status-container" class="flex items-center mb-2">
                <img src="https://unpkg.com/lucide-static@latest/icons/power.svg" alt="Power Icon" class="w-6 h-6 mr-2 text-yellow-400">
                <span id="bedroom-relay-text" class="text-lg text-gray-500">Loading...</span>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2">
                <button id="bedroom-relay-toggle" class="w-full sm:w-auto px-6 py-3 rounded bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 text-lg hidden">
                    Loading...
                </button>
                <button id="bedroom-control-btn" class="w-full sm:w-auto px-6 py-3 rounded bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 text-lg hidden">
                    Loading...
                </button>
            </div>
             <div id="bedroom-timer-status" class="text-lg text-yellow-400 mt-2 hidden"></div>
        </div>
        <div class="mt-6 border-t border-gray-700 pt-4">
            <h3 class="text-xl font-medium text-gray-400 mb-2">Temperature History</h3>
            <div class="chart-container">
                <canvas id="bedroom-temperature-chart" class="temperature-chart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-300">Kids Bedroom</h2>

        <div class="mb-4">
            <h3 class="text-xl font-medium text-gray-400 mb-1">Temperature Sensor</h3>
            <div id="kids-bedroom-sensor-status-container" class="flex items-center">
                <img src="https://unpkg.com/lucide-static@latest/icons/thermometer.svg" alt="Thermometer Icon" class="w-6 h-6 mr-2 text-yellow-400">
                <span id="kids-bedroom-sensor-text" class="text-lg text-gray-500">Loading...</span>
            </div>
            <div id="kids-bedroom-sensor-data" class="mt-2 text-gray-300 text-lg hidden">
                <p>Current: <span id="kids-bedroom-current-temp" class="font-medium">N/A</span>째C</p>
                <p>Target: <span id="kids-bedroom-target-temp" class="font-medium">N/A</span>째C</p>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="text-xl font-medium text-gray-400 mb-1">Heater Relay</h3>
            <div id="kids-bedroom-relay-status-container" class="flex items-center mb-2">
                <img src="https://unpkg.com/lucide-static@latest/icons/power.svg" alt="Power Icon" class="w-6 h-6 mr-2 text-yellow-400">
                <span id="kids-bedroom-relay-text" class="text-lg text-gray-500">Loading...</span>
            </div>
             <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2">
                <button id="kids-bedroom-relay-toggle" class="w-full sm:w-auto px-6 py-3 rounded bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 text-lg hidden">
                    Loading...
                </button>
                <button id="kids-bedroom-control-btn" class="w-full sm:w-auto px-6 py-3 rounded bg-gray-500 text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 text-lg hidden">
                    Loading...
                </button>
            </div>
            <div id="kids-bedroom-timer-status" class="text-lg text-yellow-400 mt-2 hidden"></div>
        </div>

        <div class="mt-6 border-t border-gray-700 pt-4">
            <h3 class="text-xl font-medium text-gray-400 mb-2">Temperature History</h3>
            <div class="chart-container">
                <canvas id="kids-bedroom-temperature-chart" class="temperature-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        var makeSettings = function() {
            const isDarkMode = true;
            // window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.85)';
            const currentTempColor = isDarkMode ? 'rgba(100, 180, 225, 0.25)' : 'rgb(59, 130, 146, 0.25)';
            const currentTempBgColor = isDarkMode ? 'rgba(100, 180, 243, 0.4)' : 'rgba(59, 130, 246, 0.4)';
            const targetTempColor = isDarkMode ? 'rgba(200, 200, 150, 0.7)' : 'rgb(150, 150, 100, 0.4)';
            const targetTempBgColor = isDarkMode ? 'rgba(100, 100, 100, 0.3)' : 'rgba(50, 50, 50, 0.3)';
            const pointHeaterOnColor = isDarkMode ? 'rgb(255, 99, 132)' : 'rgb(239, 68, 68)'; // Brighter Red
            const pointHeaterOffColor = isDarkMode ? 'rgba(59, 130, 246, 1)' : 'rgb(59, 130, 246)';

            return {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Current Temperature',
                            borderColor: currentTempColor,
                            backgroundColor: currentTempBgColor,
                            data: [],
                            pointRadius: 4,
                            pointBackgroundColor: function(context) {
                                const index = context.dataIndex;
                                const dataset = context.dataset;
                                return dataset.data[index]?.heater_on ? pointHeaterOnColor : pointHeaterOffColor;
                            }
                        },
                        {
                            label: 'Target Temperature',
                            borderColor: targetTempColor,
                            backgroundColor: targetTempBgColor,
                            data: [],
                            pointRadius: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            ticks: {
                                callback: function(value) {
                                    const date = new Date(value);
                                    return date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
                                },
                                color: textColor,
                                maxTicksLimit: 8,
                                autoSkip: true
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                color: textColor,
                                font: { size: 14 }
                            },
                            min: Date.now() - 3600 * 1000, // Show last 1 hour
                            max: Date.now(),
                            grid: { color: gridColor }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (째C)',
                                color: textColor,
                                font: { size: 14 }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '째C';
                                },
                                stepSize: 0.1,
                                maxTicksLimit: 6,
                                color: textColor
                            },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { mode: 'x', pinch: { enabled: true }, wheel: { enabled: true }}
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: textColor, font: {size: 14} }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const timestamp = context[0].parsed.x;
                                    const date = new Date(timestamp);
                                    return date.toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}째C`;
                                }
                            }
                        }
                    }
                }
            };
        }

        const bedroomChart = new Chart(document.getElementById('bedroom-temperature-chart').getContext('2d'), makeSettings());
        const kidsBedroomChart = new Chart(document.getElementById('kids-bedroom-temperature-chart').getContext('2d'), makeSettings());

        function merge(orig, newArray) {
            var originalArray = [...orig];
            if (originalArray.length === 0) {
                return originalArray.concat(newArray);
            }

            if (newArray.length === 0) {
                return originalArray;
            }

            const lastElementOfOriginal = originalArray[originalArray.length - 1];
            let startIndex = 0;
            while (startIndex < newArray.length && newArray[startIndex].x <= lastElementOfOriginal.x) {
                startIndex++;
            }

            // Extract the subarray from newArray starting from startIndex
            const subArrayToAppend = newArray.slice(startIndex);

            // Append the subarray to the originalArray
            return originalArray.concat(subArrayToAppend);
        };

        function updateChart(chart, history) {
            const currentData = merge(
                chart.data.datasets[0].data,
                history.map(point => ({
                    x: point.timestamp * 1000,
                    y: point.temperature,
                    heater_on: point.heater_on
                })));
            const targetData = merge(
                chart.data.datasets[1].data,
                history.map(point => ({
                    x: point.timestamp * 1000,
                    y: point.target
                })));


            var prevLen = chart.data.datasets[0].data.length;
            var isUpdated = false;

            if (currentData.length > 0) {
                var firstTimestamp = currentData[0].x;
                var lastTimestamp = currentData[currentData.length - 1].x;
                var dataRange = lastTimestamp - firstTimestamp;

                if (prevLen != 0) {
                    var prevLastTimestamp = chart.data.datasets[0].data[prevLen - 1].x;
                    isUpdated = lastTimestamp != prevLastTimestamp;
                } else {
                    isUpdated = true;
                }
            }

            var keepScrolling = false;
            if (isUpdated)  {
                keepScrolling = prevLastTimestamp != lastTimestamp && prevLastTimestamp <= chart.options.scales.x.max;
            }
            if (isUpdated) {
                console.log('isUpdated: ' + isUpdated + " keepScrolling " + keepScrolling);
            }

            chart.data.datasets[0].data = currentData;
            chart.data.datasets[1].data = targetData;

            const now = Date.now();

            if (currentData.length > 0) {
                const firstTimestamp = currentData[0].x;
                const lastTimestamp = currentData[currentData.length - 1].x;
                const dataRange = lastTimestamp - firstTimestamp;

                // Keep one point on screen
                if (lastTimestamp < chart.options.scales.x.min) {
                    var move = lastTimestamp - chart.options.scales.x.min;
                    chart.options.scales.x.min += move;
                    chart.options.scales.x.max += move;
                }
                if (firstTimestamp > chart.options.scales.x.max) {
                    var move = firstTimestamp - chart.options.scales.x.max;
                    chart.options.scales.x.min += move;
                    chart.options.scales.x.max += move;
                }
                var offset = (chart.options.scales.x.max - chart.options.scales.x.min) * 0.05;
                if (lastTimestamp + offset > chart.options.scales.x.max && keepScrolling) {
                    console.log('move: ' + chart.options.scales.x.max + " lastTimestamp " + lastTimestamp + " offset" + offset);
                    chart.options.scales.x.max = lastTimestamp + offset;
                }
            } else {
                chart.options.scales.x.min = Math.max(now - 3600 * 1000, firstTimestamp - 60000);
                chart.options.scales.x.max = now + 60000;
            }
            chart.update();
        }

        // Track if user has manually zoomed/panned
        [bedroomChart, kidsBedroomChart].forEach(chart => {
            chart.isZoomedOrPanned = false;
            const chartElement = chart.canvas;
            chartElement.addEventListener('mousedown', () => chart.isZoomedOrPanned = true); // Simple flag, might need more robust logic with chartjs-plugin-zoom events
            chartElement.addEventListener('touchstart', () => chart.isZoomedOrPanned = true);
            chartElement.addEventListener('wheel', () => chart.isZoomedOrPanned = true);
        });

        // Track last update timestamp for both rooms
        let lastUpdateTimestamp = {
            bedroom: null,
            kids_bedroom: null
        };

        function updateRoomUI(roomPrefix, data) {
            const isBedroom = roomPrefix === 'bedroom';
            let heaterDisabledUntil = data.disabled_until * 1000;

            // Sensor Elements
            const sensorTextEl = document.getElementById(`${roomPrefix}-sensor-text`);
            const sensorDataEl = document.getElementById(`${roomPrefix}-sensor-data`);
            const currentTempEl = document.getElementById(`${roomPrefix}-current-temp`);
            const targetTempEl = document.getElementById(`${roomPrefix}-target-temp`);

            // Relay Elements
            const relayTextEl = document.getElementById(`${roomPrefix}-relay-text`);
            const relayToggleBtn = document.getElementById(`${roomPrefix}-relay-toggle`);
            const controlBtn = document.getElementById(`${roomPrefix}-control-btn`);
            const timerStatusEl = document.getElementById(`${roomPrefix}-timer-status`);

            // Update Sensor UI
            if (data.sensor.available) {
                sensorTextEl.textContent = 'Available';
                sensorTextEl.className = 'text-lg text-green-400';
                sensorDataEl.classList.remove('hidden');
                currentTempEl.textContent = data.sensor.currentTemp !== null ? data.sensor.currentTemp.toFixed(1) : 'N/A';
                targetTempEl.textContent = data.sensor.targetTemp !== null ? data.sensor.targetTemp.toFixed(1) : 'N/A';
            } else {
                sensorTextEl.textContent = 'Unavailable';
                sensorTextEl.className = 'text-lg text-red-500';
                sensorDataEl.classList.add('hidden');
                currentTempEl.textContent = 'N/A';
                targetTempEl.textContent = 'N/A';
            }

            // Update Relay UI
            relayToggleBtn.classList.remove('hidden');
            controlBtn.classList.remove('hidden');

            if (data.relay.available) {
                const isHeaterDisabled = heaterDisabledUntil && Date.now() < heaterDisabledUntil;

                if (isHeaterDisabled) {
                    relayTextEl.textContent = 'Current: DISABLED';
                    relayTextEl.className = 'text-lg text-yellow-400';

                    relayToggleBtn.textContent = 'Heater Disabled';
                    relayToggleBtn.className = 'w-full sm:w-auto px-6 py-3 rounded bg-gray-600 text-gray-400 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 text-lg';
                    relayToggleBtn.disabled = true;

                    controlBtn.textContent = 'Restore Heating';
                    controlBtn.requestDisable = false;
                    controlBtn.className = 'w-full sm:w-auto px-6 py-3 rounded bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 text-lg';
                    controlBtn.disabled = false;

                    const timeLeft = Math.max(0, Math.round((heaterDisabledUntil - Date.now()) / 1000));
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerStatusEl.textContent = `Automatic restore in: ${minutes} minites`;
                    timerStatusEl.classList.remove('hidden');

                } else { // Not disabled, or timer expired
                    relayTextEl.textContent = `Current: ${data.relay.state.toUpperCase()}`;
                    relayTextEl.className = 'text-lg text-green-400';

                    relayToggleBtn.textContent = data.relay.state === 'On' ? 'Turn Off' : 'Turn On';
                    relayToggleBtn.className = `w-full sm:w-auto px-6 py-3 rounded text-white focus:outline-none focus:ring-2 focus:ring-opacity-75 text-lg ${data.relay.state === 'On' ? 'bg-red-600 hover:bg-red-700 focus:ring-red-400' : 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-400'}`;
                    relayToggleBtn.disabled = false;

                    controlBtn.textContent = 'Disable Heater for 2 Hours';
                    controlBtn.requestDisable = true;
                    controlBtn.className = 'w-full sm:w-auto px-6 py-3 rounded bg-yellow-600 text-gray-900 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75 text-lg';
                    controlBtn.disabled = false;
                    timerStatusEl.classList.add('hidden');
                }
            } else { // Relay unavailable
                relayTextEl.textContent = 'Unavailable';
                relayTextEl.className = 'text-lg text-red-500';

                relayToggleBtn.textContent = 'Toggle (Unavailable)';
                relayToggleBtn.className = 'w-full sm:w-auto px-6 py-3 rounded bg-gray-600 text-gray-400 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 text-lg';
                relayToggleBtn.disabled = true;

                controlBtn.textContent = 'Disable (Unavailable)';
                controlBtn.className = 'w-full sm:w-auto px-6 py-3 rounded bg-gray-600 text-gray-400 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 text-lg';
                controlBtn.disabled = true;
                timerStatusEl.classList.add('hidden');
            }

            const chart = roomPrefix === 'bedroom' ? bedroomChart : kidsBedroomChart;
            if (data.temperature_history) {
               updateChart(chart, data.temperature_history);
            }
        }

        async function controlRelay(room, newState) { // newState is boolean: true for On, false for Off
            const apiRoomName = room === 'kids-bedroom' ? 'kids_bedroom' : room;
            try {
                const response = await fetch('/api/relay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room: apiRoomName, state: newState })
                });
                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to control relay:', result.error);
                }
            } catch (error) {
                console.error('Error controlling relay:', error);
            }
            updateUI(); // Fetch latest state after trying to control
        }

        function handleDisableHeater(roomPrefix) {
            const apiRoomName = roomPrefix === 'kids-bedroom' ? 'kids_bedroom' : roomPrefix;
            fetch('/api/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: apiRoomName, disable: true })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.error('Failed to disable heater:', result.error);
                }
                updateUI();
            })
            .catch(error => {
                console.error('Error disabling heater:', error);
            });
        }

        function handleRestoreHeater(roomPrefix) {
            const apiRoomName = roomPrefix === 'kids-bedroom' ? 'kids_bedroom' : roomPrefix;
            fetch('/api/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room: apiRoomName, disable: false })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    console.error('Failed to restore heater:', result.error);
                }
                updateUI();
            })
            .catch(error => {
                console.error('Error restoring heater:', error);
            });
        }

        async function updateUI() {
            try {
                // Build URL with last_update parameter if we have timestamps
                let url = '/api/status';
                const params = new URLSearchParams();

                // Only add last_update if we have timestamps for both rooms
                if (lastUpdateTimestamp.bedroom || lastUpdateTimestamp.kids_bedroom) {
                    // Use the most recent timestamp to ensure we don't miss any data
                    const latestTimestamp = Math.max(lastUpdateTimestamp.bedroom, lastUpdateTimestamp.kids_bedroom);
                    params.append('last_update', latestTimestamp.toString());
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                // Update last update timestamps if we got new data
                if (data.bedroom.temperature_history.length > 0) {
                    const lastPoint = data.bedroom.temperature_history[data.bedroom.temperature_history.length - 1];
                    lastUpdateTimestamp.bedroom = lastPoint.timestamp;
                }
                if (data.kids_bedroom.temperature_history.length > 0) {
                    const lastPoint = data.kids_bedroom.temperature_history[data.kids_bedroom.temperature_history.length - 1];
                    lastUpdateTimestamp.kids_bedroom = lastPoint.timestamp;
                }

                bedroomHeaterDisabledUntil = data.bedroom.disabled_until;
                kidsBedroomHeaterDisabledUntil = data.bedroom.disabled_until;

                updateRoomUI('bedroom', {
                    sensor: {
                        available: data.bedroom.sensor_available,
                        currentTemp: data.bedroom.current_temp,
                        targetTemp: data.bedroom.target_temp
                    },
                    relay: {
                        available: data.bedroom.relay_available,
                        state: data.bedroom.relay_state ? 'On' : 'Off'
                    },
                    temperature_history: data.bedroom.temperature_history,
                    disabled_until: data.bedroom.disabled_until

                });

                updateRoomUI('kids-bedroom', {
                    sensor: {
                        available: data.kids_bedroom.sensor_available,
                        currentTemp: data.kids_bedroom.current_temp,
                        targetTemp: data.kids_bedroom.target_temp
                    },
                    relay: {
                        available: data.kids_bedroom.relay_available,
                        state: data.kids_bedroom.relay_state ? 'On' : 'Off'
                    },
                    temperature_history: data.kids_bedroom.temperature_history,
                    disabled_until: data.kids_bedroom.disabled_until
                });
            } catch (error) {
                console.error('Error fetching status:', error);
                // Optionally show a global error message on the UI
            }
        }

        // Add click handlers for toggle buttons
        document.getElementById('bedroom-relay-toggle').addEventListener('click', function() {
            if (this.disabled) return;
            const currentRelayStateText = document.getElementById('bedroom-relay-text').textContent;
            const isCurrentlyOn = currentRelayStateText.includes('ON');
            controlRelay('bedroom', !isCurrentlyOn);
        });

        document.getElementById('kids-bedroom-relay-toggle').addEventListener('click', function() {
             if (this.disabled) return;
            const currentRelayStateText = document.getElementById('kids-bedroom-relay-text').textContent;
            const isCurrentlyOn = currentRelayStateText.includes('ON');
            controlRelay('kids-bedroom', !isCurrentlyOn);
        });

        // Add click handlers for control buttons (Disable/Restore)
        document.getElementById('bedroom-control-btn').addEventListener('click', function() {
            if (this.disabled) return;
            const isHeaterDisabled = !this.requestDisable;
            if (isHeaterDisabled) {
                handleRestoreHeater('bedroom');
            } else {
                handleDisableHeater('bedroom');
            }
        });

        document.getElementById('kids-bedroom-control-btn').addEventListener('click', function() {
            if (this.disabled) return;
            const isHeaterDisabled = !this.requestDisable;

            if (isHeaterDisabled) {
                handleRestoreHeater('kids-bedroom');
            } else {
                handleDisableHeater('kids-bedroom');
            }
        });

        setInterval(updateUI, 1000);
        updateUI();
    </script>

</body>
</html>
